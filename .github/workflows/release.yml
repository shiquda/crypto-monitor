name: Release

"on":
  push:
    tags:
      - "v*"

env:
  PYTHON_VERSION: "3.13.2"

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name_prefix: crypto-monitor-windows-x64
            asset_suffix: .exe
          - os: ubuntu-latest
            artifact_name_prefix: crypto-monitor-linux-x64
            asset_suffix: ""
          - os: macos-latest
            artifact_name_prefix: crypto-monitor-macos-x64
            asset_suffix: ""

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: latest

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ runner.os }}-uv-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        run: |
          uv sync --frozen
      - name: Get version
        id: get_version
        shell: bash
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Build on Windows
        if: matrix.os == 'windows-latest'
        run: |
          Remove-Item -Recurse -Force build, dist -ErrorAction SilentlyContinue
          $iconPath = Resolve-Path "assets\icons\crypto-monitor.ico" -ErrorAction SilentlyContinue
          if ($iconPath) {
            $iconParam = "--icon=$($iconPath.Path)"
          } else {
            $iconParam = ""
          }
          $assetName = "${{ matrix.artifact_name_prefix }}-${{ env.VERSION }}${{ matrix.asset_suffix }}"
          uv run pyinstaller --onefile --windowed --name="$assetName" $iconParam --add-data="assets;assets" --add-data="imgs;imgs" --add-data="i18n;i18n" main.py

      - name: Build on Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          rm -rf build dist
          assetName="${{ matrix.artifact_name_prefix }}-${{ env.VERSION }}${{ matrix.asset_suffix }}"
          uv run pyinstaller --onefile --windowed --name="$assetName" --add-data="assets:assets" --add-data="imgs:imgs" --add-data="i18n:i18n" main.py

      - name: Build on macOS
        if: matrix.os == 'macos-latest'
        run: |
          rm -rf build dist
          assetName="${{ matrix.artifact_name_prefix }}-${{ env.VERSION }}${{ matrix.asset_suffix }}"
          uv run pyinstaller --onefile --windowed --name="$assetName" --add-data="assets:assets" --add-data="imgs:imgs" --add-data="i18n:i18n" main.py

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name_prefix }}-${{ env.VERSION }}
          path: dist/${{ matrix.artifact_name_prefix }}-${{ env.VERSION }}${{ matrix.asset_suffix }}
          if-no-files-found: error
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      attestations: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: latest

      - name: Get version from tag
        id: tag
        run: |
          echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          echo "name=$(echo ${{ github.ref_name }} | sed 's/^v//')" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f -name "crypto-monitor*" -exec mv {} release/ \;
          ls -la release/

      - name: Generate changelog
        id: changelog
        shell: python
        run: |
          import os
          import re

          def extract_changelog(version):
              try:
                  with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # Create regex pattern for the version section
                  # Matches ## [version] ... until the next ## [ or end of file
                  pattern = f"## \\[{re.escape(version)}\\].*?\\n(.*?)(?=\\n## \\[|$)"
                  match = re.search(pattern, content, re.DOTALL)
                  
                  if match:
                      return match.group(1).strip()
                  else:
                      print(f"Warning: No changelog found for version {version}")
                      return "No changelog available."
              except Exception as e:
                  print(f"Error reading changelog: {e}")
                  return "Error reading changelog."

          # Get version from GITHUB_REF (refs/tags/v0.3.0 -> 0.3.0)
          ref = os.environ.get('GITHUB_REF', '')
          version = ref.split('/')[-1]
          if version.startswith('v'):
              version = version[1:]

          changelog_text = extract_changelog(version)


          # Write to output using a random delimiter to avoid EOF conflicts
          import uuid
          delimiter = f"EOF{uuid.uuid4().hex}"
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as f:
              print(f"changelog<<{delimiter}", file=f)
              print(changelog_text, file=f)
              print(delimiter, file=f)

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.tag.outputs.version }}
          body: |
            ## ðŸ“¦ Release ${{ steps.tag.outputs.version }}

            ### Changes
            ${{ steps.changelog.outputs.changelog }}

            ### Downloads
            - Windows: crypto-monitor-windows-x64-${{ steps.tag.outputs.version }}.exe
            - Linux: crypto-monitor-linux-x64-${{ steps.tag.outputs.version }}
            - macOS: crypto-monitor-macos-x64-${{ steps.tag.outputs.version }}

            ### Installation
            **Windows:**
            1. Download `crypto-monitor-windows-x64-${{ steps.tag.outputs.version }}.exe`
            2. Run the installer
            3. Launch crypto-monitor from Start menu

            **Linux:**
            1. Download `crypto-monitor-linux-x64-${{ steps.tag.outputs.version }}`
            2. Make it executable: `chmod +x crypto-monitor-linux-x64-${{ steps.tag.outputs.version }}`
            3. Run: `./crypto-monitor-linux-x64-${{ steps.tag.outputs.version }}`

            **macOS:**
            1. Download `crypto-monitor-macos-x64-${{ steps.tag.outputs.version }}`
            2. Make it executable: `chmod +x crypto-monitor-macos-x64-${{ steps.tag.outputs.version }}`
            3. Run: `./crypto-monitor-macos-x64-${{ steps.tag.outputs.version }}`
            4. If you see a security warning, go to System Preferences > Security & Privacy and allow the app

            For more information, visit the [project repository](https://github.com/${{ github.repository }}).
          files: |
            release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
